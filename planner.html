<!doctype html>
<html lang="id">
<head>
Â  <meta charset="utf-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>Planner â€“ Sales Route</title>
Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
Â  <style>
Â  Â  :root { --bg:#0b1220; --fg:#eaf0ff; --muted:#95a3b3; --accent:#5eead4; }
Â  Â  * { box-sizing: border-box; }
Â  Â  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--fg); }
Â  Â  header { padding:12px 16px; border-bottom:1px solid #1b2233; display:flex; gap:12px; align-items:center; }
Â  Â  h1 { font-size:18px; margin:0; }
Â  Â  .container { display:grid; grid-template-columns: 320px 1fr; height: calc(100vh - 56px); }
Â  Â  #sidebar { border-right:1px solid #1b2233; padding:12px; overflow:auto; }
Â  Â  #map { height: 100%; width: 100%; }
Â  Â  button, input[type="number"], input[type="text"], select { background:#121a2a; color:var(--fg); border:1px solid #28324a; padding:8px 10px; border-radius:10px; cursor:pointer; }
Â  Â  button:hover { border-color:#34405c; }
Â  Â  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0; }
Â  Â  .list { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
Â  Â  .wp { display:flex; align-items:center; justify-content:space-between; gap:8px; background:#0f1729; border:1px solid #1e2740; border-radius:12px; padding:8px; }
Â  Â  .wp small { color:var(--muted); }
Â  Â  .drag { cursor:grab; user-select:none; opacity:.8; }
Â  Â  .pill { display:inline-block; padding:2px 8px; border:1px dashed #334; border-radius:999px; color:var(--muted); }
Â  Â  .danger { border-color:#6b2737; color:#ffb3c1; }
Â  Â  details { border:1px solid #1e2740; border-radius:12px; padding:8px; }
Â  Â  summary { cursor:pointer; color:var(--accent); }
Â  Â  a { color: var(--accent); }
Â  Â  .sep { height:1px; background:#162036; margin:12px 0; }
Â  </style>
</head>
<body>
<header>
Â  <h1>ğŸ—ºï¸ Planner â€“ Sales Route</h1>
Â  <span class="pill">Klik peta untuk tambah titik</span>
</header>
<div class="container">
Â  <aside id="sidebar">
Â  Â  <div class="row">
Â  Â  Â  <label>Radius validasi (meter):</label>
Â  Â  Â  <input id="radius" type="number" min="5" step="5" value="50"/>
Â  Â  Â  <button id="clear">Hapus semua</button>
Â  Â  </div>
Â  Â  <div class="row">
Â  Â  Â  <button id="exportPlan">ğŸ’¾ Ekspor Rencana (.json)</button>
Â  Â  Â  <input id="filePlan" type="file" accept="application/json"/>
Â  Â  Â  <button id="importPlan">ğŸ“¥ Impor Rencana</button>
Â  Â  </div>
Â  Â  <div class="sep"></div>
    
    <details open>
      <summary>â• **Tambah Lokasi Manual**</summary>
      <div style="padding-top:8px;">
        <label for="new_name" style="display:block; margin-bottom: 4px;">Nama Lokasi:</label>
        <input type="text" id="new_name" placeholder="Kantor Klien A" required style="width:100%; margin-bottom:8px;"/>

        <label for="new_type" style="display:block; margin-bottom: 4px;">Jenis Kunjungan:</label>
        <select id="new_type" style="width:100%; margin-bottom:8px;">
          <option value="Kunjungan Sales">Kunjungan Sales</option>
          <option value="Survei Lapangan">Survei Lapangan</option>
          <option value="Meeting">Meeting</option>
          <option value="Istirahat">Istirahat</option>
          <option value="Lainnya">Lainnya</option>
        </select>

        <div class="row" style="flex-wrap:nowrap;">
          <input type="number" step="any" id="new_lat" placeholder="Latitude" required style="flex-grow:1;"/>
          <input type="number" step="any" id="new_lng" placeholder="Longitude" required style="flex-grow:1;"/>
        </div>
        <button id="addManual" style="margin-top:8px; width:100%;">Tambah ke Rute</button>
      </div>
    </details>
    <div class="sep"></div>
    Â  Â  <h3>Rute / Titik</h3>
Â  Â  <div id="wpList" class="list"></div>

Â  Â  <div class="sep"></div>
Â  Â  <details>
Â  Â  Â  <summary>Verifikasi hasil perjalanan</summary>
Â  Â  Â  <div class="row" style="margin-top:8px;">
Â  Â  Â  Â  <input id="journeyFile" type="file" accept="application/json"/>
Â  Â  Â  Â  <button id="verifyBtn">ğŸ” Verifikasi</button>
Â  Â  Â  </div>
Â  Â  Â  <p id="verifyResult"></p>
Â  Â  </details>

Â  Â  <div class="sep"></div>
Â  Â  <p><small>Tips: drag & drop item untuk ubah urutan. Klik koordinat untuk fokus di peta.</small></p>
Â  </aside>
Â  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// --- State ---
// STRUKTUR DATA BARU: {id, lat, lng, name, type}
let waypoints = []; 
let markers = []; Â  
let polyline = null;
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  maxZoom: 19,
Â  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
map.setView([ -6.1754, 106.8272 ], 12); 

// Restore plan from localStorage
const saved = localStorage.getItem('sales_plan');
if (saved) {
Â  try { 
    const obj = JSON.parse(saved); 
    if (obj && Array.isArray(obj.waypoints)) { 
        waypoints = obj.waypoints; 
        document.getElementById('radius').value = obj.radius || 50; 
    } 
  } catch(e){}
}

function render() {
Â  // Clear markers/polyline
Â  markers.forEach(m => map.removeLayer(m)); markers = [];
Â  if (polyline) { map.removeLayer(polyline); polyline = null; }

Â  // Draw markers and path
Â  waypoints.forEach((wp, idx) => {
Â  Â  const m = L.marker([wp.lat, wp.lng], { draggable: true }).addTo(map);
    // Tampilkan Nama Lokasi di Tooltip
    const tooltipText = wp.name ? `#${idx+1}: ${wp.name}` : `#${idx+1}`;
Â  Â  m.bindTooltip(tooltipText, {permanent:true, direction:'top'});

Â  Â  m.on('dragend', (e)=>{ 
        const {lat, lng} = e.target.getLatLng(); 
        wp.lat = lat; 
        wp.lng = lng; 
        // Nama dan Tipe tetap, hanya lat/lng yang diubah dari drag
        persist(); 
        renderList(); 
        drawPath(); 
    });
Â  Â  m.on('click', ()=>{ map.panTo([wp.lat, wp.lng]); });
Â  Â  markers.push(m);
Â  });
Â  drawPath();
}

function drawPath(){
Â  if (polyline) { map.removeLayer(polyline); polyline = null; }
Â  const latlngs = waypoints.map(w=>[w.lat,w.lng]);
Â  if (latlngs.length>1) polyline = L.polyline(latlngs, { weight: 4 }).addTo(map);
}

function persist(){
Â  const radius = Number(document.getElementById('radius').value)||50;
Â  localStorage.setItem('sales_plan', JSON.stringify({ radius, waypoints }));
}

// Fungsi addWaypoint diperbarui agar bisa menerima data lokasi lengkap dari form
function addWaypoint({lat, lng, name='Titik Baru', type='Lainnya'}){
Â  waypoints.push({ id:crypto.randomUUID(), lat, lng, name, type });
Â  persist();
Â  render();
Â  renderList();
}

// Handler untuk klik peta (menggunakan data default)
map.on('click', (e)=> addWaypoint({lat: e.latlng.lat, lng: e.latlng.lng, name:'Titik Peta Baru'}));

// Handler untuk tombol "Tambah ke Rute" dari form manual
document.getElementById('addManual').onclick = ()=>{
    const name = document.getElementById('new_name').value.trim();
    const type = document.getElementById('new_type').value;
    const lat = Number(document.getElementById('new_lat').value);
    const lng = Number(document.getElementById('new_lng').value);

    if (!name) { alert('Nama Lokasi wajib diisi.'); return; }
    if (isNaN(lat) || lat < -90 || lat > 90) { alert('Latitude tidak valid.'); return; }
    if (isNaN(lng) || lng < -180 || lng > 180) { alert('Longitude tidak valid.'); return; }

    addWaypoint({ lat, lng, name, type });
    // Reset form
    document.getElementById('new_name').value = '';
    document.getElementById('new_lat').value = '';
    document.getElementById('new_lng').value = '';
    map.setView([lat, lng], 17); // Fokus ke lokasi baru
};


function renderList(){
Â  const list = document.getElementById('wpList');
Â  list.innerHTML = '';
Â  waypoints.forEach((wp, idx)=>{
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'wp';
Â  Â  div.draggable = true;
Â  Â  div.innerHTML = `
Â  Â  Â  <div>
Â  Â  Â  Â  <div>
            <strong>#${idx+1}: ${wp.name || 'Titik Tanpa Nama'}</strong> 
            <span class="pill">${wp.type || 'N/A'}</span>
        </div>
Â  Â  Â  Â  <small>(${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)})</small>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button data-act="focus">Fokus</button>
Â  Â  Â  Â  Â  <button data-act="del" class="danger">Hapus</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="drag">â†•ï¸</div>
Â  Â  `;
Â  Â  div.querySelector('[data-act="focus"]').onclick = ()=>{ map.setView([wp.lat, wp.lng], 17); };
Â  Â  div.querySelector('[data-act="del"]').onclick = ()=>{ waypoints.splice(idx,1); persist(); render(); renderList(); };

Â  Â  // Drag & drop reorder
Â  Â  div.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', idx.toString()); });
Â  Â  div.addEventListener('dragover', (ev)=> ev.preventDefault());
Â  Â  div.addEventListener('drop', (ev)=>{
Â  Â  Â  ev.preventDefault();
Â  Â  Â  const from = Number(ev.dataTransfer.getData('text/plain'));
Â  Â  Â  const to = idx;
Â  Â  Â  if (from===to) return;
Â  Â  Â  const [item] = waypoints.splice(from,1);
Â  Â  Â  waypoints.splice(to,0,item);
Â  Â  Â  persist();
Â  Â  Â  render();
Â  Â  Â  renderList();
Â  Â  });

Â  Â  list.appendChild(div);
Â  });
}

render();
renderList();

// Controls

document.getElementById('clear').onclick = ()=>{ if(confirm('Hapus semua titik?')) { waypoints = []; persist(); render(); renderList(); } };

document.getElementById('radius').onchange = ()=> persist();

// Export/Import Plan
function download(filename, obj){
Â  const url = URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)], {type:'application/json'}));
Â  const a = Object.assign(document.createElement('a'), { href:url, download:filename });
Â  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

Â document.getElementById('exportPlan').onclick = ()=>{
Â  const radius = Number(document.getElementById('radius').value)||50;
Â  const obj = { type:'sales-plan', version:1, createdAt:new Date().toISOString(), radius, waypoints };
Â  download('sales-plan.json', obj);
Â };

document.getElementById('importPlan').onclick = ()=>{
Â  const inp = document.getElementById('filePlan');
Â  if (!inp.files[0]) { alert('Pilih file rencana .json'); return; }
Â  const r = new FileReader();
Â  r.onload = ()=>{
Â  Â  try { 
        const obj = JSON.parse(r.result);
Â  Â  Â  Â  if (obj && obj.waypoints) { 
            // Memastikan data yang diimpor tetap memiliki name/type (jika ada)
            waypoints = obj.waypoints.map(wp => ({
                id: wp.id || crypto.randomUUID(), 
                lat: wp.lat, 
                lng: wp.lng, 
                name: wp.name || 'Titik Impor', // Menambahkan default jika tidak ada
                type: wp.type || 'Lainnya'
            }));
            document.getElementById('radius').value = obj.radius||50; 
            persist(); 
            render(); 
            renderList(); 
        } else alert('Format tidak dikenali');
Â  Â  } catch(e){ alert('Gagal parse JSON'); }
Â  };
Â  r.readAsText(inp.files[0]);
};

// --- Verification ---
function haversine(a,b){
Â  const R=6371000; const toRad=x=>x*Math.PI/180;
Â  const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lng-a.lng);
Â  const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
Â  const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
Â  return 2*R*Math.asin(Math.sqrt(h));
}

function verifyJourney(plan, journey){
Â  const radius = plan.radius || 50;
Â  const points = (journey.track||[]);
Â  let idx = 0; // waypoint index
Â  const hits = [];
Â  for (let i=0;i<points.length && idx<plan.waypoints.length;i++){
Â  Â  const p = points[i];
Â  Â  const w = plan.waypoints[idx];
Â  Â  const d = haversine({lat:p.lat,lng:p.lng},{lat:w.lat,lng:w.lng});
Â  Â  if (d <= radius) { hits.push({wpIndex: idx, atPoint: i, dist: d}); idx++; }
Â  }
Â  const ok = idx===plan.waypoints.length;
Â  return { ok, hits, visited: idx, total: plan.waypoints.length };
}

Â document.getElementById('verifyBtn').onclick = ()=>{
Â  const jf = document.getElementById('journeyFile');
Â  if (!jf.files[0]) { alert('Unggah file hasil perjalanan (JSON) dari tracker'); return; }
Â  const r = new FileReader();
Â  r.onload = ()=>{
Â  Â  try {
Â  Â  Â  const journey = JSON.parse(r.result);
Â  Â  Â  const plan = { radius: Number(document.getElementById('radius').value)||50, waypoints };
Â  Â  Â  const res = verifyJourney(plan, journey);
Â  Â  Â  const msg = res.ok ? `âœ… Cocok: ${res.visited}/${res.total} titik tercapai berurutan.` : `âŒ Belum cocok: ${res.visited}/${res.total} titik yang terdeteksi berurutan.`;
Â  Â  Â  document.getElementById('verifyResult').textContent = msg;
Â  Â  } catch(e){ alert('Format hasil perjalanan tidak valid'); }
Â  };
Â  r.readAsText(jf.files[0]);
Â };
</script>
</body>
</html>