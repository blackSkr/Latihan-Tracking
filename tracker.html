<!DOCTYPE html>
<html lang="id">
<head>
 <meta charset="utf-8"/>
 <meta name="viewport" content="width=device-width, initial-scale=1"/>
 <title>Tracker â€“ Sales Route</title>
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
 <style>
  :root { --bg:#0b1220; --fg:#eaf0ff; --muted:#95a3b3; --accent:#5eead4; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg); }
  header { padding:12px 16px; border-bottom:1px solid #1b2233; display:flex; gap:12px; align-items:center; justify-content:space-between; }
  h1 { font-size:18px; margin:0; }
  #map { height: calc(100vh - 250px); width: 100%; }
  .panel { padding:12px 16px; display:grid; gap:8px; }
  button, input[type="file"] { background:#121a2a; color:var(--fg); border:1px solid #28324a; padding:10px 12px; border-radius:12px; cursor:pointer; }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .pill { display:inline-block; padding:2px 8px; border:1px dashed #334; border-radius:999px; color:var(--muted); font-size: 12px; margin-left: 8px;}
  ul { list-style:none; padding:0; margin:0; }
  li { padding:6px 8px; margin:4px 0; border:1px solid #28324a; border-radius:8px; display:flex; flex-direction: column; background:#121a2a; }
    li > div { display: flex; justify-content: space-between; align-items: center; }
  .done { color:#34d399; }
  .pending { color:#fca5a5; }
 </style>
</head>
<body>
<header>
 <h1>ğŸ“ Tracker â€“ Sales Route</h1>
 <span class="pill">Aktifkan GPS & izinkan lokasi</span>
</header>

<div class="panel">
 <div class="grid">
  <div><input id="planFile" type="file" accept="application/json"/></div>
  <div>
   <button id="startBtn">â–¶ï¸ Mulai</button>
   <button id="stopBtn" disabled>â¹ï¸ Stop</button>
  </div>
 </div>
 <div>
  <span>Progress: </span><strong id="progress">0/0</strong>
  <span id="status" class="pill">Idle</span>
 </div>
</div>

<div id="map"></div>

<div class="panel">
 <h3>Daftar Tujuan</h3>
 <ul id="waypointList"></ul>
 <button id="exportJourney" disabled>ğŸ’¾ Ekspor Hasil Perjalanan (.json)</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let plan = null;
let visitedIdx = 0;
let track = [];
let watchId = null;
let map = L.map("map");
let youMarker = null;
let pathLine = null;
let wMarkers = [];
let wpListEl = document.getElementById("waypointList");

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
 maxZoom: 19,
 attribution: "&copy; OpenStreetMap contributors"
}).addTo(map);

// Default ke Samarinda
map.setView([-0.502106, 117.153709], 14);

function loadPlanFromFile(file){
 return new Promise((resolve,reject)=>{
  const r = new FileReader();
  r.onload = ()=>{ try{ resolve(JSON.parse(r.result)); } catch(e){ reject(e); } };
  r.onerror = reject;
  r.readAsText(file);
 });
}

document.getElementById("planFile").addEventListener("change", async (e)=>{
 const f = e.target.files[0]; if (!f) return;
 try {
  const obj = await loadPlanFromFile(f);
  if (obj.type==="sales-plan" && Array.isArray(obj.waypoints)){
   // Memastikan waypoint memiliki name dan type, beri default jika kosong
   const waypoints = obj.waypoints.map(wp => ({
    ...wp,
    name: wp.name || `Titik #${wp.id}`,
    type: wp.type || 'Lainnya'
   }));
   plan = { radius: obj.radius||50, waypoints };
   
   visitedIdx = 0; updateProgress();
   drawWaypoints();
   renderList();
   document.getElementById("status").textContent = 
    `Plan dimuat (${plan.waypoints.length} titik, radius ${plan.radius}m)`;
  } else alert("Format rencana tidak dikenali");
 } catch(err){ alert("Gagal baca rencana: "+err.message); }
});

function drawWaypoints(){
 wMarkers.forEach(m=>map.removeLayer(m)); wMarkers=[];
 if (!plan) return;
 const latlngs = [];
 plan.waypoints.forEach((w,i)=>{
  // Membuat popup dengan Nama dan Jenis Kunjungan
  const popupContent = `<strong>#${i+1} - ${w.name}</strong><br>Jenis: ${w.type}<br>Lat/Lng: ${w.lat.toFixed(6)}, ${w.lng.toFixed(6)}`;
  
  const m = L.circle([w.lat,w.lng], { radius: plan.radius, weight:1, fillOpacity:0.1, color:"#fca5a5" });
  m.addTo(map).bindTooltip(`#${i+1}: ${w.name}`).bindPopup(popupContent);
  wMarkers.push(m);
  latlngs.push([w.lat,w.lng]);
 });
 if (latlngs.length) map.fitBounds(L.latLngBounds(latlngs), { padding:[30,30] });
}

// Fungsi renderList diperbarui untuk menampilkan nama dan jenis kunjungan
function renderList(){
 wpListEl.innerHTML="";
 if (!plan) return;
 plan.waypoints.forEach((w,i)=>{
  const li=document.createElement("li");
  li.id="wp-"+i;
  li.innerHTML=`
   <div>
    <span><strong>#${i+1} ${w.name}</strong></span>
    <span class="status pending">âŒ</span>
   </div>
   <div>
    <small>${w.lat.toFixed(5)}, ${w.lng.toFixed(5)}</small>
    <span class="pill">${w.type}</span>
   </div>
  `;
  wpListEl.appendChild(li);
 });
}

function updateProgress(){
 const tot = plan? plan.waypoints.length:0;
 document.getElementById("progress").textContent = `${visitedIdx}/${tot}`;
}

function haversine(a,b){
 const R=6371000; const toRad=x=>x*Math.PI/180;
 const dLat = toRad(b.lat-a.lat), dLon = toRad(b.lng-a.lng);
 const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
 const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
 return 2*R*Math.asin(Math.sqrt(h));
}

function onPosition(pos){
 const { latitude, longitude } = pos.coords;
 const now = new Date().toISOString();
 track.push({ lat: latitude, lng: longitude, ts: now });

 const latlng = [latitude, longitude];
 if (!youMarker){ youMarker = L.marker(latlng).addTo(map).bindTooltip("Anda",{permanent:true}); }
 else youMarker.setLatLng(latlng);

 if (pathLine) map.removeLayer(pathLine);
 pathLine = L.polyline(track.map(p=>[p.lat,p.lng]), { weight:4, color:"#5eead4" }).addTo(map);
 map.panTo(latlng); // Fokuskan peta ke posisi user

 // Cek waypoint
 if (plan && visitedIdx < plan.waypoints.length){
  const target = plan.waypoints[visitedIdx];
  const d = haversine({lat:latitude,lng:longitude}, {lat:target.lat,lng:target.lng});
  if (d <= plan.radius){
   // mark visited
   const li = document.getElementById("wp-"+visitedIdx);
   if (li){
    li.querySelector(".status").textContent="âœ…";
    li.querySelector(".status").className="status done";
   }
   const circle = wMarkers[visitedIdx];
   if (circle) circle.setStyle({color:"#34d399"});
   visitedIdx++; updateProgress();
   document.getElementById("status").textContent = `âœ… Titik #${visitedIdx} tercapai`;
   if (visitedIdx===plan.waypoints.length){
    document.getElementById("status").textContent="ğŸ‰ Semua titik tercapai. Ekspor hasil.";
    document.getElementById("exportJourney").disabled=false;
    // Otomatis stop tracking saat semua tercapai
    document.getElementById("stopBtn").click();
   }
  } else {
   document.getElementById("status").textContent = `Berjalanâ€¦ jarak ke ${target.name}: ${Math.round(d)}m`;
  }
 }
}

function onError(err){
 document.getElementById("status").textContent = "GPS error: "+err.message;
}

document.getElementById("startBtn").onclick=()=>{
 if (!plan){ alert("Muat rencana (sales-plan.json) dulu"); return; }
 if (watchId) return;
 track=[]; visitedIdx=0; updateProgress(); renderList(); drawWaypoints();
 if (!navigator.geolocation){ alert("Geolocation tidak didukung"); return; }
 document.getElementById("status").textContent="Tracking dimulaiâ€¦";
 watchId = navigator.geolocation.watchPosition(onPosition, onError, { enableHighAccuracy:true, maximumAge:1000, timeout:20000 });
 document.getElementById("stopBtn").disabled=false;
 document.getElementById("startBtn").disabled=true;
};

document.getElementById("stopBtn").onclick=()=>{
 if (watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; document.getElementById("status").textContent="Tracking dihentikan"; }
 document.getElementById("stopBtn").disabled=true;
 document.getElementById("startBtn").disabled=false;
};

function download(filename,obj){
 const url=URL.createObjectURL(new Blob([JSON.stringify(obj,null,2)], {type:"application/json"}));
 const a=Object.assign(document.createElement("a"),{href:url,download:filename});
 document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

document.getElementById("exportJourney").onclick=()=>{
 const data={ type:"sales-journey", version:1, exportedAt:new Date().toISOString(), visited:visitedIdx, total:plan?plan.waypoints.length:0, track };
 download("sales-journey.json", data);
};

// Initial state check
if (!plan) document.getElementById("startBtn").disabled=true;
document.getElementById("planFile").addEventListener("change", (e)=>{
    if(e.target.files.length > 0) document.getElementById("startBtn").disabled=false;
});
</script>
</body>
</html>